# Claire de Binare - AlertManager Configuration
# Issue #96: Monitoring & Alerting

global:
  # Global timeout settings
  resolve_timeout: 5m

  # SMTP configuration (placeholder - configure for production)
  # smtp_smarthost: 'smtp.example.com:587'
  # smtp_from: 'alertmanager@claire-trading.local'
  # smtp_auth_username: 'alertmanager'
  # smtp_auth_password: '<secret>'

# Route tree
route:
  # Default receiver
  receiver: 'default-receiver'

  # Group alerts by these labels
  group_by: ['alertname', 'severity', 'service']

  # Wait before sending first notification
  group_wait: 30s

  # Wait before sending subsequent notifications
  group_interval: 5m

  # Wait before sending resolved notification
  repeat_interval: 4h

  # Child routes for specific severities
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # High priority alerts
    - match:
        severity: high
      receiver: 'high-priority-receiver'
      group_wait: 1m
      repeat_interval: 2h

    # Circuit breaker specific
    - match:
        alertname: CircuitBreakerTriggered
      receiver: 'trading-halt-receiver'
      group_wait: 0s
      repeat_interval: 30m

# Inhibition rules - prevent notification floods
inhibit_rules:
  # If service is down, suppress all other alerts for that service
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.+'
    equal: ['service']

  # If database is down, suppress order processing alerts
  - source_match:
      alertname: 'DatabaseConnectionLost'
    target_match:
      alertname: 'OrderProcessingDelayed'

  # If critical alert fires, suppress warnings for same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service']

# Receivers
receivers:
  - name: 'default-receiver'
    # Webhook to signal service
    webhook_configs:
      - url: 'http://cdb_signal:8005/alerts'
        send_resolved: true

  - name: 'critical-receiver'
    webhook_configs:
      - url: 'http://cdb_signal:8005/alerts/critical'
        send_resolved: true
    # Add email/Slack/PagerDuty for production
    # email_configs:
    #   - to: 'oncall@claire-trading.local'

  - name: 'high-priority-receiver'
    webhook_configs:
      - url: 'http://cdb_signal:8005/alerts/high'
        send_resolved: true

  - name: 'trading-halt-receiver'
    webhook_configs:
      - url: 'http://cdb_signal:8005/alerts/trading-halt'
        send_resolved: true
    # This receiver triggers kill-switch webhook
    # In production: add PagerDuty/OpsGenie integration

# Templates (optional)
templates:
  - '/etc/alertmanager/templates/*.tmpl'

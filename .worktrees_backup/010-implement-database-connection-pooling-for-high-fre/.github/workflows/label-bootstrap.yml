name: Label Bootstrap (Copilot)

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  labels:
    runs-on: ubuntu-latest
    environment: copilot
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh jq

      - name: Authenticate GH CLI
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth status

      - name: Load label spec
        id: spec
        shell: bash
        run: |
          SPEC_PATH="${{ vars.LABEL_SPEC_PATH }}"
          if [ -z "$SPEC_PATH" ]; then SPEC_PATH=".github/labels.json"; fi
          if [ ! -f "$SPEC_PATH" ]; then
            echo "Label spec not found at: $SPEC_PATH"
            echo "Set vars.LABEL_SPEC_PATH or commit .github/labels.json"
            exit 1
          fi
          echo "spec_path=$SPEC_PATH" >> "$GITHUB_OUTPUT"
          echo "Using spec: $SPEC_PATH"
          jq '.' "$SPEC_PATH" >/dev/null

      - name: Apply labels (create/update)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRY="${{ vars.DRY_RUN }}"
          REPO="${{ github.repository }}"
          SPEC="${{ steps.spec.outputs.spec_path }}"

          echo "DRY_RUN=$DRY"
          echo "Repo=$REPO"
          echo "Spec=$SPEC"

          # Fetch existing labels into a map: name -> url
          existing=$(gh api "repos/$REPO/labels?per_page=100" --paginate | jq -r '.[].name')
          echo "$existing" > /tmp/existing_labels.txt

          total=$(jq '.labels | length' "$SPEC")
          echo "Labels in spec: $total"

          jq -c '.labels[]' "$SPEC" | while read -r item; do
            name=$(echo "$item" | jq -r '.name')
            color=$(echo "$item" | jq -r '.color' | tr -d '#')
            desc=$(echo "$item" | jq -r '.description // ""')

            if grep -Fxq "$name" /tmp/existing_labels.txt; then
              echo "Update label: $name"
              if [ "$DRY" = "true" ]; then
                echo "[DRY_RUN] gh api -X PATCH repos/$REPO/labels/{name} -f new_name=... -f color=... -f description=..."
              else
                # PATCH uses old name in URL; keep name stable unless you intentionally rename.
                gh api -X PATCH "repos/$REPO/labels/$(python - <<'PY'
import urllib.parse,sys
print(urllib.parse.quote(sys.argv[1]))
PY
"$name")"                   -f new_name="$name" -f color="$color" -f description="$desc" >/dev/null
              fi
            else
              echo "Create label: $name"
              if [ "$DRY" = "true" ]; then
                echo "[DRY_RUN] gh label create "$name" --color "$color" --description "$desc""
              else
                gh label create "$name" --color "$color" --description "$desc" >/dev/null
              fi
            fi
          done

      - name: Optional cleanup (delete labels not in spec)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CLEAN="${{ vars.LABEL_CLEANUP }}"
          DRY="${{ vars.DRY_RUN }}"
          REPO="${{ github.repository }}"
          SPEC_PATH="${{ steps.spec.outputs.spec_path }}"

          if [ "$CLEAN" != "true" ]; then
            echo "LABEL_CLEANUP != true â†’ skip deletion."
            exit 0
          fi

          echo "Cleanup enabled: deleting labels not present in spec."
          spec_names=$(jq -r '.labels[].name' "$SPEC_PATH" | sort)
          existing=$(gh api "repos/$REPO/labels?per_page=100" --paginate | jq -r '.[].name' | sort)

          comm -23 <(echo "$existing") <(echo "$spec_names") | while read -r name; do
            # Never delete GitHub default labels unless you explicitly want to.
            if [[ "$name" =~ ^(bug|documentation|duplicate|enhancement|good first issue|help wanted|invalid|question|wontfix)$ ]]; then
              echo "Skip default label: $name"
              continue
            fi

            echo "Delete label: $name"
            if [ "$DRY" = "true" ]; then
              echo "[DRY_RUN] gh label delete "$name" --yes"
            else
              gh label delete "$name" --yes >/dev/null
            fi
          done

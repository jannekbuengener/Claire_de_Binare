# Event-Sourcing Schema - Claire de Binaire
# Version: 1.0.0
# Purpose: Deterministic Replay Engine with Full Audit Trail

schema_version: "1.0.0"
system: "Claire de Binaire"
description: "Complete event-sourcing schema for deterministic replay and audit-trail"

# ============================================================================
# CORE PRINCIPLES
# ============================================================================
principles:
  - "Every decision is an event"
  - "Events are immutable and append-only"
  - "Logical clock ensures deterministic ordering"
  - "Full audit trail: what, when, why"
  - "Replay from events = same decisions"

# ============================================================================
# LOGICAL CLOCK
# ============================================================================
logical_clock:
  description: "Monotonically increasing sequence number, independent of system time"
  type: "int64"
  start_value: 1
  increment: 1
  guarantees:
    - "Event N always comes before Event N+1"
    - "No dependency on wall-clock time"
    - "Deterministic ordering across replay"
  implementation: "PostgreSQL sequence or Redis INCR"

# ============================================================================
# BASE EVENT STRUCTURE
# ============================================================================
base_event:
  description: "All events inherit this structure"
  fields:
    event_id:
      type: "uuid"
      required: true
      description: "Unique identifier for this event"

    event_type:
      type: "string"
      required: true
      description: "Type of event (MarketData, Signal, RiskDecision, etc.)"
      enum:
        - "market_data"
        - "signal_generated"
        - "risk_decision"
        - "order_request"
        - "order_result"
        - "position_update"
        - "alert"
        - "state_snapshot"
        - "system_event"

    sequence_number:
      type: "int64"
      required: true
      description: "Monotonically increasing logical clock value"
      indexed: true

    timestamp_utc:
      type: "datetime"
      required: true
      description: "Wall-clock time (for humans, not for ordering)"
      format: "ISO 8601"

    timestamp_logical:
      type: "int64"
      required: true
      description: "Bot-internal logical timestamp (milliseconds since bot start)"

    causation_id:
      type: "uuid"
      required: false
      description: "Event ID that caused this event (for tracing)"

    correlation_id:
      type: "uuid"
      required: true
      description: "Session/Trade ID to group related events"

    metadata:
      type: "object"
      required: true
      description: "Additional context for audit trail"
      fields:
        service:
          type: "string"
          description: "Service that generated this event"
        version:
          type: "string"
          description: "Service version"
        environment:
          type: "string"
          description: "paper|live"

    payload:
      type: "object"
      required: true
      description: "Event-specific data (different for each event_type)"

# ============================================================================
# EVENT TYPES
# ============================================================================

event_types:

  # --------------------------------------------------------------------------
  # MARKET DATA EVENT
  # --------------------------------------------------------------------------
  market_data:
    description: "Market data received from exchange"
    producer: "cdb_ws, cdb_rest"
    consumers: ["cdb_core"]
    frequency: "continuous"
    payload:
      symbol:
        type: "string"
        required: true
        example: "BTCUSDT"
      price:
        type: "float"
        required: true
        description: "Current market price"
      volume:
        type: "float"
        required: true
        description: "Trading volume"
      bid:
        type: "float"
        required: false
        description: "Best bid price"
      ask:
        type: "float"
        required: false
        description: "Best ask price"
      pct_change:
        type: "float"
        required: false
        description: "Percentage change"
      interval:
        type: "string"
        required: true
        example: "1m"
    audit_fields:
      - "symbol"
      - "price"
      - "timestamp_utc"

  # --------------------------------------------------------------------------
  # SIGNAL GENERATED EVENT
  # --------------------------------------------------------------------------
  signal_generated:
    description: "Trading signal generated by strategy"
    producer: "cdb_core"
    consumers: ["cdb_risk"]
    frequency: "on_demand"
    payload:
      symbol:
        type: "string"
        required: true
      side:
        type: "string"
        required: true
        enum: ["BUY", "SELL"]
      confidence:
        type: "float"
        required: true
        description: "Signal confidence (0.0 - 1.0)"
        min: 0.0
        max: 1.0
      reason:
        type: "string"
        required: true
        description: "Why this signal was generated"
      requested_size:
        type: "float"
        required: false
        description: "Requested position size"
      price:
        type: "float"
        required: true
        description: "Price at signal generation"
      strategy_params:
        type: "object"
        required: true
        description: "Strategy parameters used"
        fields:
          momentum_threshold:
            type: "float"
          rsi_value:
            type: "float"
          volume_ma:
            type: "float"
    audit_fields:
      - "symbol"
      - "side"
      - "confidence"
      - "reason"
      - "strategy_params"

  # --------------------------------------------------------------------------
  # RISK DECISION EVENT
  # --------------------------------------------------------------------------
  risk_decision:
    description: "Risk manager decision on signal"
    producer: "cdb_risk"
    consumers: ["cdb_execution"]
    frequency: "on_demand"
    payload:
      signal_id:
        type: "uuid"
        required: true
        description: "ID of signal being evaluated"
      approved:
        type: "boolean"
        required: true
        description: "Signal approved or rejected"
      reason:
        type: "string"
        required: true
        description: "Reason for approval/rejection"
      symbol:
        type: "string"
        required: true
      side:
        type: "string"
        required: true
      approved_size:
        type: "float"
        required: false
        description: "Approved position size (may differ from requested)"
      stop_price:
        type: "float"
        required: false
        description: "Calculated stop-loss price"
      risk_checks:
        type: "object"
        required: true
        description: "All risk checks performed"
        fields:
          daily_drawdown:
            type: "object"
            fields:
              checked: "boolean"
              passed: "boolean"
              current_value: "float"
              limit: "float"
          exposure_limit:
            type: "object"
            fields:
              checked: "boolean"
              passed: "boolean"
              current_value: "float"
              limit: "float"
          position_size:
            type: "object"
            fields:
              checked: "boolean"
              passed: "boolean"
              current_value: "float"
              limit: "float"
          data_quality:
            type: "object"
            fields:
              checked: "boolean"
              passed: "boolean"
              age_seconds: "float"
              max_age: "float"
      risk_state:
        type: "object"
        required: true
        description: "Complete risk state at decision time"
        fields:
          equity:
            type: "float"
          daily_pnl:
            type: "float"
          total_exposure_pct:
            type: "float"
          open_positions:
            type: "int"
    audit_fields:
      - "signal_id"
      - "approved"
      - "reason"
      - "risk_checks"
      - "risk_state"

  # --------------------------------------------------------------------------
  # ORDER REQUEST EVENT
  # --------------------------------------------------------------------------
  order_request:
    description: "Order request sent to execution service"
    producer: "cdb_risk"
    consumers: ["cdb_execution"]
    frequency: "on_demand"
    payload:
      risk_decision_id:
        type: "uuid"
        required: true
      symbol:
        type: "string"
        required: true
      side:
        type: "string"
        required: true
        enum: ["BUY", "SELL"]
      size:
        type: "float"
        required: true
      stop_price:
        type: "float"
        required: false
      limit_price:
        type: "float"
        required: false
      order_type:
        type: "string"
        required: true
        enum: ["MARKET", "LIMIT", "STOP_LOSS"]
    audit_fields:
      - "risk_decision_id"
      - "symbol"
      - "side"
      - "size"

  # --------------------------------------------------------------------------
  # ORDER RESULT EVENT
  # --------------------------------------------------------------------------
  order_result:
    description: "Result of order execution"
    producer: "cdb_execution"
    consumers: ["cdb_risk", "dashboard", "cdb_postgres"]
    frequency: "on_demand"
    payload:
      order_request_id:
        type: "uuid"
        required: true
      order_id:
        type: "string"
        required: true
        description: "Exchange order ID or MOCK ID"
      status:
        type: "string"
        required: true
        enum: ["FILLED", "PARTIAL", "REJECTED", "CANCELED"]
      filled_quantity:
        type: "float"
        required: false
      fill_price:
        type: "float"
        required: false
      fees:
        type: "float"
        required: false
      slippage:
        type: "float"
        required: false
        description: "Actual slippage vs. expected price"
      error_message:
        type: "string"
        required: false
    audit_fields:
      - "order_request_id"
      - "status"
      - "filled_quantity"
      - "fill_price"
      - "slippage"

  # --------------------------------------------------------------------------
  # POSITION UPDATE EVENT
  # --------------------------------------------------------------------------
  position_update:
    description: "Position opened, modified, or closed"
    producer: "cdb_execution"
    consumers: ["cdb_risk", "dashboard"]
    frequency: "on_demand"
    payload:
      position_id:
        type: "uuid"
        required: true
      symbol:
        type: "string"
        required: true
      action:
        type: "string"
        required: true
        enum: ["OPENED", "MODIFIED", "CLOSED"]
      side:
        type: "string"
        required: true
        enum: ["LONG", "SHORT"]
      quantity:
        type: "float"
        required: true
      entry_price:
        type: "float"
        required: false
      current_price:
        type: "float"
        required: false
      unrealized_pnl:
        type: "float"
        required: false
      realized_pnl:
        type: "float"
        required: false
        description: "Only on CLOSED"
    audit_fields:
      - "position_id"
      - "symbol"
      - "action"
      - "quantity"
      - "realized_pnl"

  # --------------------------------------------------------------------------
  # ALERT EVENT
  # --------------------------------------------------------------------------
  alert:
    description: "System alert (risk limit, error, warning)"
    producer: "cdb_risk, cdb_execution, any service"
    consumers: ["dashboard", "logs"]
    frequency: "on_demand"
    payload:
      code:
        type: "string"
        required: true
        description: "Alert code"
        examples: ["RISK_LIMIT", "CIRCUIT_BREAKER", "DATA_STALE", "ORDER_FAILED"]
      level:
        type: "string"
        required: true
        enum: ["CRITICAL", "WARNING", "INFO"]
      message:
        type: "string"
        required: true
      context:
        type: "object"
        required: false
        description: "Additional context"
    audit_fields:
      - "code"
      - "level"
      - "message"

  # --------------------------------------------------------------------------
  # STATE SNAPSHOT EVENT
  # --------------------------------------------------------------------------
  state_snapshot:
    description: "Periodic snapshot of system state for faster replay"
    producer: "cdb_risk, cdb_core"
    consumers: ["replay_engine"]
    frequency: "periodic (every N events or time interval)"
    payload:
      snapshot_type:
        type: "string"
        required: true
        enum: ["RISK_STATE", "SIGNAL_STATE", "FULL_STATE"]
      state_data:
        type: "object"
        required: true
        description: "Complete state serialized as JSON"
      checksum:
        type: "string"
        required: true
        description: "SHA256 checksum for integrity"
    audit_fields:
      - "snapshot_type"
      - "checksum"

  # --------------------------------------------------------------------------
  # SYSTEM EVENT
  # --------------------------------------------------------------------------
  system_event:
    description: "System lifecycle events (start, stop, error)"
    producer: "any service"
    consumers: ["monitoring"]
    frequency: "rare"
    payload:
      event_name:
        type: "string"
        required: true
        examples: ["SERVICE_STARTED", "SERVICE_STOPPED", "CONFIG_RELOADED"]
      details:
        type: "object"
        required: false
    audit_fields:
      - "event_name"

# ============================================================================
# STORAGE
# ============================================================================
storage:
  database: "PostgreSQL"
  table: "events"
  partitioning: "by_date"
  retention: "unlimited (or configurable)"
  indexes:
    - column: "sequence_number"
      type: "btree"
      unique: true
    - column: "timestamp_utc"
      type: "btree"
    - column: "event_type"
      type: "btree"
    - column: "correlation_id"
      type: "btree"
    - column: "causation_id"
      type: "btree"

# ============================================================================
# REPLAY ENGINE
# ============================================================================
replay:
  description: "Replay events from log to reconstruct state"
  modes:
    full:
      description: "Replay all events from beginning"
      use_case: "Full system validation"
    range:
      description: "Replay events in time/sequence range"
      use_case: "Debug specific period"
      parameters:
        - "from_sequence"
        - "to_sequence"
        - "from_timestamp"
        - "to_timestamp"
    from_snapshot:
      description: "Start from state snapshot + replay delta"
      use_case: "Faster replay for recent periods"

  guarantees:
    - "Same events â†’ same decisions (determinism)"
    - "No side effects during replay"
    - "All risk checks executed identically"

  exclusions:
    - "No external API calls during replay"
    - "No Redis pub/sub during replay"
    - "Read-only mode for databases"

# ============================================================================
# AUDIT TRAIL
# ============================================================================
audit_trail:
  description: "Explain any decision retroactively"
  query_interface:
    by_time:
      example: "Show all events between 2025-02-10 13:00 and 13:30"
    by_symbol:
      example: "Show all BTC events"
    by_correlation_id:
      example: "Show all events for trade #12345"
    by_causation_chain:
      example: "Show what caused order_result #ABC"

  explain_decision:
    input: "event_id of risk_decision or order_result"
    output:
      - "Market data seen"
      - "Signal that triggered"
      - "Risk state at decision time"
      - "All risk checks with results"
      - "Causation chain back to market data"

  compliance:
    description: "Full audit trail for regulatory compliance"
    includes:
      - "Who: service and version"
      - "What: decision and outcome"
      - "When: both logical and wall-clock time"
      - "Why: reason, checks, state"
      - "How: strategy params, risk params"

# ============================================================================
# VERSIONING
# ============================================================================
versioning:
  schema_version: "1.0.0"
  migration_strategy: "Additive only (no breaking changes)"
  new_fields: "Always optional for backwards compatibility"
  deprecation: "Minimum 6 months notice before removal"

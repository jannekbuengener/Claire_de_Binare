# Canonical System Schema - Claire de Binare
# Erstellt von: software-jochen
# Datum: 2025-11-16
# Quellen: extracted_knowledge.md, infra_knowledge.md, output.md, ARCHITEKTUR.md, docker-compose.yml

version: "1.0.0"
system_name: "Claire de Binare"
description: "Automated paper trading system for cryptocurrency markets"

# ============================================================================
# SERVICES
# ============================================================================
services:
  - id: "cdb_redis"
    name: "Redis"
    description: "Message Broker for Pub/Sub communication"
    container_name: "cdb_redis"
    image: "redis:7-alpine"
    port_host: 6379
    port_container: 6379
    health_endpoint: "redis-cli ping"
    health_check:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: "10s"
      timeout: "3s"
      retries: 3
    dependencies: []
    consumes_topics: []
    produces_topics: []
    env_variables: ["REDIS_PASSWORD"]
    volumes:
      - source: "redis_data"
        target: "/data"
    security_flags:
      no_new_privileges: false
      cap_drop: []
      read_only: false
      tmpfs: []
    network: "cdb_network"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - id: "cdb_postgres"
    name: "PostgreSQL"
    description: "Database for persisting orders, trades, risk events"
    container_name: "cdb_postgres"
    image: "postgres:15-alpine"
    port_host: 5432
    port_container: 5432
    health_endpoint: "pg_isready"
    health_check:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: "10s"
      timeout: "3s"
      retries: 3
    dependencies: []
    consumes_topics: []
    produces_topics: []
    env_variables: ["POSTGRES_USER", "POSTGRES_PASSWORD", "POSTGRES_DB"]
    volumes:
      - source: "postgres_data"
        target: "/var/lib/postgresql/data"
      - source: "./backoffice/docs/DATABASE_SCHEMA.sql"
        target: "/docker-entrypoint-initdb.d/01-schema.sql"
        read_only: true
    security_flags:
      no_new_privileges: false
      cap_drop: []
      read_only: false
      tmpfs: []
    network: "cdb_network"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - id: "cdb_prometheus"
    name: "Prometheus"
    description: "Metrics collection and monitoring"
    container_name: "cdb_prometheus"
    image: "prom/prometheus:latest"
    port_host: 19090
    port_container: 9090
    health_endpoint: "/-/healthy"
    health_check:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/-/healthy"]
      interval: "30s"
      timeout: "10s"
      retries: 3
    dependencies: []
    consumes_topics: []
    produces_topics: []
    env_variables: []
    volumes:
      - source: "./prometheus.yml"
        target: "/etc/prometheus/prometheus.yml"
        read_only: true
      - source: "prom_data"
        target: "/prometheus"
    security_flags:
      no_new_privileges: false
      cap_drop: []
      read_only: false
      tmpfs: []
    network: "cdb_network"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "prometheus.yml", "infra_knowledge.md"]

  - id: "cdb_grafana"
    name: "Grafana"
    description: "Visualization and dashboards"
    container_name: "cdb_grafana"
    image: "grafana/grafana:latest"
    port_host: 3000
    port_container: 3000
    health_endpoint: "/api/health"
    health_check:
      test: ["CMD", "curl", "-fsS", "http://localhost:3000/api/health"]
      interval: "30s"
      timeout: "10s"
      retries: 3
    dependencies: ["cdb_prometheus"]
    consumes_topics: []
    produces_topics: []
    env_variables: ["GF_SECURITY_ADMIN_USER", "GF_SECURITY_ADMIN_PASSWORD", "GF_USERS_ALLOW_SIGN_UP"]
    volumes:
      - source: "grafana_data"
        target: "/var/lib/grafana"
    security_flags:
      no_new_privileges: false
      cap_drop: []
      read_only: false
      tmpfs: []
    network: "cdb_network"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - id: "cdb_ws"
    name: "WebSocket Screener"
    description: "Real-time market data ingestion via WebSocket"
    container_name: "cdb_ws"
    image: "build:Dockerfile"
    build_args:
      SCRIPT_NAME: "mexc_top5_ws.py"
    port_host: 8000
    port_container: 8000
    health_endpoint: "/health"
    health_check:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: "30s"
      timeout: "5s"
      retries: 3
    dependencies: ["cdb_redis"]
    consumes_topics: []
    produces_topics: ["market_data"]
    env_variables: ["REDIS_HOST", "REDIS_PORT", "REDIS_PASSWORD", "MEXC_API_KEY"]
    volumes:
      - source: "./logs"
        target: "/app/logs"
    security_flags:
      no_new_privileges: true
      cap_drop: ["ALL"]
      read_only: true
      tmpfs: ["/tmp"]
    network: "cdb_network"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "extracted_knowledge.md", "infra_knowledge.md"]

  - id: "cdb_rest"
    name: "REST Screener"
    description: "Polling-based market data ingestion via REST API"
    container_name: "cdb_rest"
    image: "build:Dockerfile"
    build_args:
      SCRIPT_NAME: "mexc_top_movers.py"
    port_host: 8080
    port_container: 8080
    health_endpoint: "none"  # Periodic loop, no HTTP server
    health_check:
      test: ["CMD", "true"]
      interval: "30s"
      timeout: "3s"
      retries: 3
    dependencies: ["cdb_redis"]
    consumes_topics: []
    produces_topics: ["market_data"]
    env_variables: ["REDIS_HOST", "REDIS_PORT", "REDIS_PASSWORD", "MEXC_API_KEY"]
    volumes:
      - source: "./logs"
        target: "/app/logs"
    security_flags:
      no_new_privileges: true
      cap_drop: ["ALL"]
      read_only: false  # Conflict: should be true
      tmpfs: ["/tmp"]
    network: "cdb_network"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "infra_knowledge.md", "infra_conflicts.md#SR-005"]

  - id: "cdb_core"
    name: "Signal Engine"
    description: "Momentum-based trading signal generation"
    container_name: "cdb_core"
    image: "build:./backoffice/services/signal_engine/Dockerfile"
    port_host: 8001
    port_container: 8001
    health_endpoint: "/health"
    metrics_endpoint: "/metrics"
    health_check:
      test: ["CMD", "curl", "-fsS", "http://localhost:8001/health"]
      interval: "30s"
      timeout: "3s"
      retries: 3
    dependencies: ["cdb_redis", "cdb_ws"]
    consumes_topics: ["market_data"]
    produces_topics: ["signals"]
    env_variables: ["REDIS_HOST", "REDIS_PORT", "REDIS_PASSWORD", "SIGNAL_THRESHOLD", "MIN_VOLUME"]
    volumes:
      - source: "./backoffice/services/signal_engine"
        target: "/app"  # Development mode
      - source: "signal_data"
        target: "/data"
    security_flags:
      no_new_privileges: true
      cap_drop: ["ALL"]
      read_only: true
      tmpfs: ["/tmp"]
    network: "cdb_network"
    network_alias: "signal_engine"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "extracted_knowledge.md", "infra_knowledge.md"]

  - id: "cdb_risk"
    name: "Risk Manager"
    description: "Multi-layered risk management and order validation"
    container_name: "cdb_risk"
    image: "build:./backoffice/services/risk_manager/Dockerfile"
    port_host: 8002
    port_container: 8002
    health_endpoint: "/health"
    metrics_endpoint: "/metrics"
    health_check:
      test: ["CMD", "curl", "-fsS", "http://localhost:8002/health"]
      interval: "30s"
      timeout: "3s"
      retries: 3
    dependencies: ["cdb_redis", "cdb_core"]
    consumes_topics: ["signals"]
    produces_topics: ["orders", "alerts"]
    env_variables:
      - "REDIS_HOST"
      - "REDIS_PORT"
      - "REDIS_PASSWORD"
      - "MAX_DAILY_DRAWDOWN_PCT"
      - "MAX_EXPOSURE_PCT"
      - "MAX_POSITION_PCT"
      - "STOP_LOSS_PCT"
      - "MAX_SLIPPAGE_PCT"
      - "MAX_SPREAD_MULTIPLIER"
      - "DATA_STALE_TIMEOUT_SEC"
    volumes:
      - source: "./backoffice/services/risk_manager"
        target: "/app"  # Development mode
      - source: "risk_logs"
        target: "/logs"
    security_flags:
      no_new_privileges: true
      cap_drop: ["ALL"]
      read_only: true
      tmpfs: ["/tmp"]
    network: "cdb_network"
    network_alias: "risk_manager"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "extracted_knowledge.md", "output.md", "infra_knowledge.md"]

  - id: "cdb_execution"
    name: "Execution Service"
    description: "Paper trading order execution"
    container_name: "cdb_execution"
    image: "build:./backoffice/services/execution_service/Dockerfile"
    port_host: 8003
    port_container: 8003
    health_endpoint: "/health"
    metrics_endpoint: "/metrics"
    health_check:
      test: ["CMD", "curl", "-fsS", "http://localhost:8003/health"]
      interval: "30s"
      timeout: "3s"
      retries: 3
    dependencies: ["cdb_redis", "cdb_risk", "cdb_postgres"]
    consumes_topics: ["orders"]
    produces_topics: ["order_results", "alerts"]
    env_variables: ["REDIS_HOST", "REDIS_PORT", "REDIS_PASSWORD", "DATABASE_URL"]
    volumes:
      - source: "./backoffice/services/execution_service"
        target: "/app"  # Development mode
    security_flags:
      no_new_privileges: true
      cap_drop: ["ALL"]
      read_only: true
      tmpfs: ["/tmp"]
      user: "1000:1000"  # Explicit non-root
    network: "cdb_network"
    network_alias: "execution_service"
    restart_policy: "unless-stopped"
    sources: ["docker-compose.yml", "extracted_knowledge.md", "infra_knowledge.md"]

# ============================================================================
# ENV-VARIABLEN
# ============================================================================
env_variables:
  # Database
  - key: "POSTGRES_DB"
    description: "PostgreSQL database name"
    category: "Infra"
    type: "string"
    default: "claire_de_binare"
    required: true
    scope: "global"
    used_by_services: ["cdb_postgres", "cdb_execution"]
    sources: ["env_index.md", " - Kopie.env"]

  - key: "POSTGRES_USER"
    description: "PostgreSQL username"
    category: "Infra"
    type: "string"
    default: null
    required: true
    scope: "global"
    used_by_services: ["cdb_postgres", "cdb_execution"]
    sources: ["env_index.md", " - Kopie.env"]

  - key: "POSTGRES_PASSWORD"
    description: "PostgreSQL password"
    category: "Secret"
    type: "string"
    default: null
    required: true
    scope: "global"
    used_by_services: ["cdb_postgres", "cdb_execution"]
    sources: ["env_index.md", " - Kopie.env", "infra_conflicts.md#SR-001"]

  - key: "DATABASE_URL"
    description: "Full PostgreSQL connection string"
    category: "Infra"
    type: "string"
    default: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@cdb_postgres:5432/${POSTGRES_DB}"
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_execution"]
    sources: ["env_index.md", " - Kopie.env"]

  # Redis
  - key: "REDIS_HOST"
    description: "Redis hostname"
    category: "Infra"
    type: "string"
    default: "cdb_redis"
    required: true
    scope: "global"
    used_by_services: ["cdb_ws", "cdb_rest", "cdb_core", "cdb_risk", "cdb_execution"]
    sources: ["env_index.md", " - Kopie.env"]

  - key: "REDIS_PORT"
    description: "Redis port"
    category: "Infra"
    type: "int"
    default: 6379
    required: true
    scope: "global"
    used_by_services: ["cdb_ws", "cdb_rest", "cdb_core", "cdb_risk", "cdb_execution"]
    sources: ["env_index.md", " - Kopie.env"]

  - key: "REDIS_PASSWORD"
    description: "Redis password (requirepass)"
    category: "Secret"
    type: "string"
    default: null
    required: true
    scope: "global"
    used_by_services: ["cdb_redis", "cdb_ws", "cdb_rest", "cdb_core", "cdb_risk", "cdb_execution"]
    sources: ["env_index.md", " - Kopie.env", "docker-compose.yml"]

  # Risk Management Parameters
  - key: "MAX_DAILY_DRAWDOWN_PCT"
    description: "Maximum daily drawdown limit (decimal format)"
    category: "Config"
    type: "float"
    unit: "decimal"
    default: 0.05
    min: 0.01
    max: 0.20
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_risk"]
    sources: ["output.md", "extracted_knowledge.md", "env_index.md#Konflikt"]

  - key: "MAX_EXPOSURE_PCT"
    description: "Maximum portfolio exposure (decimal format)"
    category: "Config"
    type: "float"
    unit: "decimal"
    default: 0.50
    min: 0.10
    max: 1.00
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_risk"]
    sources: ["output.md", "extracted_knowledge.md"]

  - key: "MAX_POSITION_PCT"
    description: "Maximum position size (decimal format)"
    category: "Config"
    type: "float"
    unit: "decimal"
    default: 0.10
    min: 0.01
    max: 0.25
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_risk"]
    sources: ["output.md", "extracted_knowledge.md"]

  - key: "STOP_LOSS_PCT"
    description: "Stop-loss per trade (decimal format)"
    category: "Config"
    type: "float"
    unit: "decimal"
    default: 0.02
    min: 0.005
    max: 0.10
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_risk"]
    sources: ["output.md", "env_index.md#Fehlt in .env"]

  - key: "MAX_SLIPPAGE_PCT"
    description: "Maximum allowed slippage (decimal format)"
    category: "Config"
    type: "float"
    unit: "decimal"
    default: 0.01
    min: 0.001
    max: 0.05
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_risk"]
    sources: ["output.md", "env_index.md#Fehlt in .env"]

  - key: "MAX_SPREAD_MULTIPLIER"
    description: "Maximum spread multiplier for market anomalies"
    category: "Config"
    type: "float"
    unit: "multiplier"
    default: 5.0
    min: 2.0
    max: 10.0
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_risk"]
    sources: ["output.md", "env_index.md#Fehlt in .env"]

  - key: "DATA_STALE_TIMEOUT_SEC"
    description: "Data staleness timeout in seconds"
    category: "Config"
    type: "int"
    unit: "seconds"
    default: 30
    min: 10
    max: 120
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_risk"]
    sources: ["output.md", "env_index.md#Fehlt in .env"]

  # MEXC API
  - key: "MEXC_API_KEY"
    description: "MEXC exchange API key"
    category: "Secret"
    type: "string"
    default: null
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_ws", "cdb_rest"]
    sources: ["env_index.md#Fehlt in .env", "infra_conflicts.md#SR-003"]

  - key: "MEXC_API_SECRET"
    description: "MEXC exchange API secret"
    category: "Secret"
    type: "string"
    default: null
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_ws", "cdb_rest"]
    sources: ["env_index.md#Fehlt in .env", "infra_conflicts.md#SR-003"]

  # Signal Engine
  - key: "SIGNAL_THRESHOLD"
    description: "Momentum signal threshold (percentage)"
    category: "Config"
    type: "float"
    unit: "percent"
    default: 3.0
    min: 1.0
    max: 10.0
    required: false
    scope: "service-specific"
    used_by_services: ["cdb_core"]
    sources: [" - Kopie.env", "env_index.md"]

  - key: "MIN_VOLUME"
    description: "Minimum trading volume required"
    category: "Config"
    type: "int"
    unit: "units"
    default: 100000
    required: false
    scope: "service-specific"
    used_by_services: ["cdb_core"]
    sources: [" - Kopie.env", "env_index.md"]

  # Grafana
  - key: "GF_SECURITY_ADMIN_USER"
    description: "Grafana admin username"
    category: "Infra"
    type: "string"
    default: "admin"
    required: false
    scope: "service-specific"
    used_by_services: ["cdb_grafana"]
    sources: ["docker-compose.yml", "env_index.md"]

  - key: "GF_SECURITY_ADMIN_PASSWORD"
    description: "Grafana admin password"
    category: "Secret"
    type: "string"
    default: null
    required: true
    scope: "service-specific"
    used_by_services: ["cdb_grafana"]
    sources: ["docker-compose.yml", "env_index.md", "infra_conflicts.md#Duplikat?"]

# ============================================================================
# RISK-PARAMETER
# ============================================================================
risk_parameters:
  - name: "Daily Drawdown Limit"
    env_key: "MAX_DAILY_DRAWDOWN_PCT"
    unit: "decimal"
    default: 0.05
    min: 0.01
    max: 0.20
    layer: 1
    effect: "Halt trading immediately, manual override required"
    guard_type: "hard_limit"
    sources: ["output.md", "extracted_knowledge.md", "Risikomanagement-Logik.md"]

  - name: "Portfolio Exposure Limit"
    env_key: "MAX_EXPOSURE_PCT"
    unit: "decimal"
    default: 0.50
    min: 0.10
    max: 1.00
    layer: 4
    effect: "Block new orders, existing positions remain"
    guard_type: "soft_limit"
    sources: ["output.md", "extracted_knowledge.md"]

  - name: "Position Size Limit"
    env_key: "MAX_POSITION_PCT"
    unit: "decimal"
    default: 0.10
    min: 0.01
    max: 0.25
    layer: 5
    effect: "Trim order to limit (not reject)"
    guard_type: "soft_limit"
    sources: ["output.md", "extracted_knowledge.md"]

  - name: "Stop-Loss per Trade"
    env_key: "STOP_LOSS_PCT"
    unit: "decimal"
    default: 0.02
    min: 0.005
    max: 0.10
    layer: 6
    effect: "Automatic exit, alert RISK_LIMIT/WARNING"
    guard_type: "hard_limit"
    sources: ["output.md", "extracted_knowledge.md"]

  - name: "Maximum Slippage"
    env_key: "MAX_SLIPPAGE_PCT"
    unit: "decimal"
    default: 0.01
    min: 0.001
    max: 0.05
    layer: 2
    effect: "Circuit breaker, pause until normalization"
    guard_type: "circuit_breaker"
    sources: ["output.md"]

  - name: "Spread Anomaly Multiplier"
    env_key: "MAX_SPREAD_MULTIPLIER"
    unit: "multiplier"
    default: 5.0
    min: 2.0
    max: 10.0
    layer: 2
    effect: "Circuit breaker, pause until normalization"
    guard_type: "circuit_breaker"
    sources: ["output.md"]

  - name: "Data Staleness Timeout"
    env_key: "DATA_STALE_TIMEOUT_SEC"
    unit: "seconds"
    default: 30
    min: 10
    max: 120
    layer: 3
    effect: "Pause new orders, hold existing positions"
    guard_type: "circuit_breaker"
    sources: ["output.md"]

# ============================================================================
# EVENTS
# ============================================================================
events:
  - topic: "market_data"
    producers: ["cdb_ws", "cdb_rest"]
    consumers: ["cdb_core"]
    schema:
      symbol: "string"
      price: "float"
      volume: "float"
      timestamp: "int"
      pct_change: "float"
    frequency: "continuous"
    retention: "none"
    sources: ["extracted_knowledge.md", "EVENT_SCHEMA.json"]

  - topic: "signals"
    producers: ["cdb_core"]
    consumers: ["cdb_risk"]
    schema:
      symbol: "string"
      direction: "string"  # BUY/SELL
      size: "float"
      signal_strength: "float"
      timestamp: "int"
    frequency: "on-demand"
    retention: "persist to DB"
    sources: ["extracted_knowledge.md", "EVENT_SCHEMA.json"]

  - topic: "orders"
    producers: ["cdb_risk"]
    consumers: ["cdb_execution"]
    schema:
      symbol: "string"
      side: "string"  # BUY/SELL
      size: "float"
      approved_by: "string"
      risk_checks: "object"
      timestamp: "int"
    frequency: "on-demand"
    retention: "persist to DB"
    sources: ["extracted_knowledge.md", "EVENT_SCHEMA.json"]

  - topic: "order_results"
    producers: ["cdb_execution"]
    consumers: ["cdb_risk", "dashboard", "cdb_postgres"]
    schema:
      order_id: "string"
      status: "string"  # filled/rejected/partial
      fill_price: "float"
      fees: "float"
      timestamp: "int"
    frequency: "on-demand"
    retention: "persist to DB"
    sources: ["extracted_knowledge.md", "EVENT_SCHEMA.json"]

  - topic: "alerts"
    producers: ["cdb_risk", "cdb_execution"]
    consumers: ["dashboard", "logs"]
    schema:
      code: "string"  # RISK_LIMIT, CIRCUIT_BREAKER, DATA_STALE
      level: "string"  # CRITICAL, WARNING, INFO
      message: "string"
      timestamp: "int"
    frequency: "on-demand"
    retention: "persist to DB"
    sources: ["extracted_knowledge.md", "output.md", "EVENT_SCHEMA.json"]

# ============================================================================
# MONITORING
# ============================================================================
monitoring:
  - type: "metric"
    name: "prometheus_scrape"
    source: "prometheus"
    target: "prometheus"
    scrape_interval: "15s"
    jobs:
      - job_name: "prometheus"
        targets: ["localhost:9090"]
      - job_name: "execution_service"
        targets: ["execution_service:8003"]
      - job_name: "signal_engine"
        targets: ["signal_engine:8001"]
      - job_name: "risk_manager"
        targets: ["risk_manager:8002"]
    sources: ["prometheus.yml", "infra_knowledge.md"]

  - type: "alert"
    name: "risk_limit_alert"
    source: "cdb_risk"
    level: "CRITICAL"
    target: "alerts"
    payload_format:
      code: "RISK_LIMIT"
      level: "CRITICAL"
      message: "string"
      timestamp: "int"
    sources: ["output.md", "extracted_knowledge.md"]

  - type: "alert"
    name: "circuit_breaker_alert"
    source: "cdb_risk"
    level: "WARNING"
    target: "alerts"
    payload_format:
      code: "CIRCUIT_BREAKER"
      level: "WARNING"
      message: "string"
      timestamp: "int"
    sources: ["output.md", "extracted_knowledge.md"]

# ============================================================================
# STORAGE
# ============================================================================
storage:
  - type: "volume"
    name: "redis_data"
    driver: "local"
    used_by_services: ["cdb_redis"]
    backup_policy: null
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - type: "volume"
    name: "postgres_data"
    driver: "local"
    used_by_services: ["cdb_postgres"]
    backup_policy: null
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - type: "volume"
    name: "prom_data"
    driver: "local"
    used_by_services: ["cdb_prometheus"]
    backup_policy: null
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - type: "volume"
    name: "grafana_data"
    driver: "local"
    used_by_services: ["cdb_grafana"]
    backup_policy: null
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - type: "volume"
    name: "signal_data"
    driver: "local"
    used_by_services: ["cdb_core"]
    backup_policy: null
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - type: "volume"
    name: "risk_logs"
    driver: "local"
    used_by_services: ["cdb_risk"]
    backup_policy: null
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - type: "database"
    name: "claire_de_binare"
    driver: "postgres"
    used_by_services: ["cdb_postgres", "cdb_execution"]
    backup_policy: "manual"
    sources: ["docker-compose.yml", " - Kopie.env"]

# ============================================================================
# SECURITY
# ============================================================================
security_policies:
  - policy_name: "MVP Service Hardening"
    scope: "service"
    flags:
      no_new_privileges: true
      cap_drop: ["ALL"]
      read_only: true
      tmpfs: ["/tmp"]
    applied_to: ["cdb_ws", "cdb_core", "cdb_risk", "cdb_execution"]
    risk_level: "HIGH"
    enforcement: "mandatory"
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - policy_name: "Infra Service Missing Hardening"
    scope: "service"
    flags:
      no_new_privileges: false
      cap_drop: []
      read_only: false
    applied_to: ["cdb_redis", "cdb_postgres", "cdb_prometheus", "cdb_grafana"]
    risk_level: "HIGH"
    enforcement: "recommended"
    sources: ["infra_conflicts.md#SR-004"]

  - policy_name: "Secrets Management"
    scope: "env"
    flags:
      never_commit: true
      use_placeholders: true
    applied_to: ["POSTGRES_PASSWORD", "REDIS_PASSWORD", "MEXC_API_KEY", "MEXC_API_SECRET", "GF_SECURITY_ADMIN_PASSWORD"]
    risk_level: "CRITICAL"
    enforcement: "mandatory"
    sources: ["infra_conflicts.md#SR-001", " - Kopie.env"]

# ============================================================================
# INFRA/RUNTIME
# ============================================================================
infrastructure:
  - type: "network"
    name: "cdb_network"
    configuration:
      driver: "bridge"
    services: ["cdb_redis", "cdb_postgres", "cdb_prometheus", "cdb_grafana", "cdb_ws", "cdb_rest", "cdb_core", "cdb_risk", "cdb_execution"]
    sources: ["docker-compose.yml", "infra_knowledge.md"]

  - type: "port_mapping"
    name: "prometheus_port_mapping"
    configuration:
      host: 19090
      container: 9090
      reason: "Avoid conflict with local Prometheus"
    services: ["cdb_prometheus"]
    sources: ["docker-compose.yml", "infra_knowledge.md", "infra_conflicts.md#SR-009"]

# ============================================================================
# CONFLICTS (unresolved)
# ============================================================================
conflicts:
  - id: "CONFLICT-001"
    category: "ENV-Naming"
    description: "Risk parameters have different names in .env vs. documentation"
    affected_entities: ["MAX_DAILY_DRAWDOWN", "MAX_DAILY_DRAWDOWN_PCT"]
    sources: ["env_index.md", "infra_conflicts.md#Konflikt-1"]
    resolution_proposal: "Use decimal convention (_PCT suffix)"
    risk_level: "CRITICAL"

  - id: "CONFLICT-002"
    category: "File-Redundanz"
    description: "cdb_signal_gen service references missing Dockerfile"
    affected_entities: ["cdb_signal_gen", "Dockerfile.signal_gen"]
    sources: ["docker-compose.yml", "file_index.md", "infra_knowledge.md"]
    resolution_proposal: "Remove service from compose or restore Dockerfile"
    risk_level: "HIGH"

  - id: "CONFLICT-003"
    category: "Security-Inkonsistenz"
    description: "cdb_rest missing read_only flag"
    affected_entities: ["cdb_rest"]
    sources: ["infra_knowledge.md", "infra_conflicts.md#SR-005"]
    resolution_proposal: "Add read_only: true"
    risk_level: "HIGH"

version: 2.1

executors:
  python-executor:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/project

jobs:
  install-deps:
    executor: python-executor
    steps:
      - checkout
      - restore_cache:
          name: Restore pip cache
          keys:
            - pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - pip-{{ arch }}-
      - run:
          name: Install project dependencies
          command: |
            if [ -f requirements.txt ]; then
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            else
              echo "requirements.txt not found – skipping"
            fi
      - save_cache:
          name: Save pip cache
          key: pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
          paths:
            - ~/.cache/pip

  lint:
    executor: python-executor
    steps:
      - checkout
      - restore_cache:
          name: Restore pip cache
          keys:
            - pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - pip-{{ arch }}-
      - run:
          name: Install linting dependencies
          command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt || echo "no requirements.txt"
            pip install black ruff
      - run:
          name: Run Black
          command: black --check .
      - run:
          name: Run Ruff
          command: ruff check .

  unit-tests:
    executor: python-executor
    steps:
      - checkout
      - restore_cache:
          name: Restore pip cache
          keys:
            - pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - pip-{{ arch }}-
      - run:
          name: Install test dependencies
          command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt || echo "no requirements.txt"
            pip install pytest pytest-cov
      - run:
          name: Run unit tests
          command: |
            pytest --maxfail=1 --disable-warnings -q

  docker-compose-test:
    docker:
      - image: cimg/base:stable
    working_directory: ~/project
    steps:
      - checkout
      - setup_remote_docker:
          version: 24.0.2
      - run:
          name: Build & start Cleanroom stack
          command: |
            docker compose up --build -d
      - run:
          name: Show running containers
          command: |
            sleep 10
            docker ps
      - run:
          name: Show service status (optional)
          command: |
            docker compose ps
      - run:
          name: Dump last logs on failure
          when: on_fail
          command: |
            docker compose logs --tail=200 || true
      - run:
          name: Tear down stack
          when: always
          command: |
            docker compose down

workflows:
  version: 2

  ci:
    jobs:
      # -----------------------------------------
      # Feature-Branches (alles außer main):
      # Lint + Tests, kein Docker-Compose
      # -----------------------------------------
      - install-deps:
          name: install-deps-feature
          filters:
            branches:
              ignore: main
            tags:
              ignore: /.*/
      - lint:
          name: lint-feature
          requires:
            - install-deps-feature
          filters:
            branches:
              ignore: main
            tags:
              ignore: /.*/
      - unit-tests:
          name: unit-tests-feature
          requires:
            - install-deps-feature
          filters:
            branches:
              ignore: main
            tags:
              ignore: /.*/

      # -----------------------------------------
      # main-Branch:
      # Lint + Tests + Docker-Compose-Smoketest
      # -----------------------------------------
      - install-deps:
          name: install-deps-main
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
      - lint:
          name: lint-main
          requires:
            - install-deps-main
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
      - unit-tests:
          name: unit-tests-main
          requires:
            - install-deps-main
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
      - docker-compose-test:
          name: docker-compose-test-main
          requires:
            - unit-tests-main
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/

      # -----------------------------------------
      # Tags im Format vX.Y.Z (Releases):
      # Tests + Docker-Compose-Smoketest
      # -----------------------------------------
      - install-deps:
          name: install-deps-tag
          filters:
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+$/
            branches:
              ignore: /.*/
      - unit-tests:
          name: unit-tests-tag
          requires:
            - install-deps-tag
          filters:
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+$/
            branches:
              ignore: /.*/
      - docker-compose-test:
          name: docker-compose-test-tag
          requires:
            - unit-tests-tag
          filters:
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+$/
            branches:
              ignore: /.*/

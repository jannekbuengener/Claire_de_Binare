name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'tests/e2e/**'
      - 'services/**'
      - 'infrastructure/compose/**'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches: [main]
    paths:
      - 'tests/e2e/**'
      - 'services/**'
      - 'infrastructure/compose/**'
      - '.github/workflows/e2e.yml'

jobs:
  e2e_smoke:
    name: E2E Smoke Test (market_data → signal)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio requests redis

      - name: Create .env file
        run: |
          cat > .env << EOF
          # E2E Test Environment
          WS_SOURCE=stub
          REDIS_HOST=localhost
          REDIS_PORT=6379
          REDIS_PASSWORD=
          LOG_LEVEL=INFO
          EOF

      - name: Start Docker Compose stack
        run: |
          docker compose -f infrastructure/compose/base.yml \
                         -f infrastructure/compose/monitoring.yml \
                         -f infrastructure/compose/logging.yml \
                         up -d

      - name: Wait for services to be healthy
        run: |
          echo "⏳ Waiting for services to be healthy..."
          timeout=60
          elapsed=0

          while [ $elapsed -lt $timeout ]; do
            all_healthy=true

            for service in cdb_redis cdb_prometheus cdb_signal; do
              health=$(docker inspect --format='{{.State.Health.Status}}' $service 2>/dev/null || echo "not_found")

              if [ "$health" != "healthy" ]; then
                echo "  ⏳ $service not healthy yet (status: $health)"
                all_healthy=false
                break
              fi
            done

            if [ "$all_healthy" = true ]; then
              echo "✅ All services healthy"
              break
            fi

            sleep 2
            elapsed=$((elapsed + 2))
          done

          if [ $elapsed -ge $timeout ]; then
            echo "❌ Timeout waiting for services to be healthy"
            docker ps --filter name=cdb_
            docker logs cdb_signal --tail 50
            exit 1
          fi

      - name: Run E2E Smoke Tests
        run: |
          pytest tests/e2e/test_smoke_pipeline.py -v --tb=short --no-cov

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== cdb_signal logs ==="
          docker logs cdb_signal --tail 100

          echo "=== cdb_ws logs ==="
          docker logs cdb_ws --tail 100

          echo "=== cdb_redis logs ==="
          docker logs cdb_redis --tail 50

          echo "=== Docker ps ==="
          docker ps --filter name=cdb_

      - name: Teardown Docker Compose stack
        if: always()
        run: |
          docker compose -f infrastructure/compose/base.yml \
                         -f infrastructure/compose/monitoring.yml \
                         -f infrastructure/compose/logging.yml \
                         down -v

      - name: E2E test summary
        if: success()
        run: |
          echo "## ✅ E2E Smoke Test Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- market_data fixture published (10 deterministic messages)" >> $GITHUB_STEP_SUMMARY
          echo "- cdb_signal generated signals" >> $GITHUB_STEP_SUMMARY
          echo "- Prometheus metrics validated (signals_generated_total > 0)" >> $GITHUB_STEP_SUMMARY

# Delivery Gate CI Check
# Enforces governance/DELIVERY_APPROVED.yaml before merging PRs
# Constitution ¬ß4.2: Only humans may approve delivery

name: Delivery Gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-delivery-gate:
    name: Check Delivery Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Check for exception labels
        id: exceptions
        env:
          LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
        run: |
          echo "Checking PR labels: $LABELS"

          # Exception labels that bypass the gate
          EXCEPTION_LABELS=$(yq -r '.exceptions.labels[]' governance/DELIVERY_APPROVED.yaml 2>/dev/null || echo "")

          for label in $(echo "$EXCEPTION_LABELS" | tr '\n' ' '); do
            if echo "$LABELS" | grep -qi "$label"; then
              echo "‚úÖ Exception label found: $label - bypassing delivery gate"
              echo "bypassed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "bypassed=false" >> $GITHUB_OUTPUT

      - name: Check Delivery Gate
        if: steps.exceptions.outputs.bypassed != 'true'
        run: |
          GATE_FILE="governance/DELIVERY_APPROVED.yaml"

          if [ ! -f "$GATE_FILE" ]; then
            echo "‚ö†Ô∏è Delivery gate file not found: $GATE_FILE"
            echo "Creating PRs is allowed, but merge requires approval."
            exit 0
          fi

          APPROVED=$(yq '.delivery.approved' "$GATE_FILE")
          REASON=$(yq '.delivery.reason' "$GATE_FILE")
          APPROVED_BY=$(yq '.delivery.approved_by' "$GATE_FILE")

          echo "================================"
          echo "üö¶ Delivery Gate Status"
          echo "================================"
          echo "Approved: $APPROVED"
          echo "Reason: $REASON"
          echo "Approved by: $APPROVED_BY"
          echo "================================"

          if [ "$APPROVED" = "true" ]; then
            echo "‚úÖ Delivery gate is OPEN - merges allowed"
          else
            echo "‚ùå Delivery gate is CLOSED"
            echo ""
            echo "To unblock:"
            echo "1. Update governance/DELIVERY_APPROVED.yaml"
            echo "2. Set delivery.approved: true"
            echo "3. Add your name to approved_by"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.exceptions.outputs.bypassed }}" = "true" ]; then
            echo "üè∑Ô∏è PR has exception label - delivery gate bypassed"
          else
            echo "‚úÖ Delivery gate check complete"
          fi

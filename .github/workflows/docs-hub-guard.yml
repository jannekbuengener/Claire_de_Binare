name: Docs Hub Guard

on:
  pull_request:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Block runtime artifacts
        shell: bash
        run: |
          set -euo pipefail
          echo "Scanning for runtime artifacts..."
          bad="$(git ls-files | grep -E '(^|/)(__pycache__/|\.pytest_cache/|.*\.pyc$|.*\.pyo$|.*\.log$|(^|/)logs/)' || true)"
          if [ -n "$bad" ]; then
            echo "Found forbidden runtime artifacts tracked in git:"
            echo "$bad"
            exit 1
          fi

      - name: Basic secret pattern scan (best-effort)
        shell: bash
        run: |
          set -euo pipefail
          echo "Best-effort secret scan (patterns)."
          include_paths=(
            knowledge
            governance
            docs
          )
          git fetch origin main >/dev/null 2>&1 || true
          mapfile -t changed_files < <(git diff --name-only origin/main)
          scan_files=()
          for char in "${include_paths[@]}"; do
            for file in "${changed_files[@]}"; do
              if [[ "$file" == "$char"* ]]; then
                scan_files+=("$file")
              fi
            done
          done
          if [ "${#scan_files[@]}" -eq 0 ]; then
            echo "Keine Änderungen in den überwachten Ordnern; Secret-Scan übersprungen."
            exit 0
          fi
          hits="$(git grep -nEI '(api[_-]?key|secret|token|private[_-]?key|BEGIN (RSA|OPENSSH) PRIVATE KEY|xox[baprs]-|ghp_[A-Za-z0-9]{20,}|AKIA[0-9A-Z]{16})' -- "${scan_files[@]}" || true)"
          if [ -n "$hits" ]; then
            echo "Potential secret-like strings found in geänderten Dateien (review required):"
            echo "$hits"
            echo ""
            echo "If these are false positives, adjust the workflow patterns or move values to local .env/.secrets."
            exit 1
          fi

      - name: Enforce canonical top-level folders
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking canonical top-level folders..."
          for d in governance knowledge agents docs; do
            if [ ! -d "$d" ]; then
              echo "Missing required top-level folder: $d"
              exit 1
            fi
          done

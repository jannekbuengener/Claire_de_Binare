name: CI/CD Pipeline

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manueller Trigger

env:
  PYTHON_VERSION: '3.12'
  CACHE_VERSION: 1

jobs:
  # ============================================
  # CODE QUALITY CHECKS
  # ============================================

  core-guard:
    name: Core Duplicates Guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run core duplicates check
        run: python scripts/check_core_duplicates.py

  lint:
    name: Linting (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff
        run: ruff check . --output-format=github

  format-check:
    name: Format Check (Black)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Black
        run: pip install black==23.12.1

      - name: Check formatting
        run: black --check --diff .

  type-check:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          # Install base dev requirements if they exist
          if [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
          else
            pip install mypy
          fi

      - name: Run mypy
        run: mypy services/ --ignore-missing-imports --no-strict-optional
        continue-on-error: true  # Nicht blockierend in MVP-Phase

  # ============================================
  # TESTS
  # ============================================

  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          # Install base dev requirements if they exist
          if [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
          else
            pip install pytest pytest-cov
          fi

      - name: Run tests with coverage
        run: |
          pytest -v -m "not e2e and not local_only" \
            --cov=services \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

      - name: Coverage comment
        if: matrix.python-version == '3.12'
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # SECURITY CHECKS
  # ============================================

  secrets-scan:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Volle Historie fÃ¼r Gitleaks

      - name: Run Gitleaks
        run: |
          # Download and install gitleaks
          GITLEAKS_VERSION="v8.21.0"
          curl -sSL -o gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_8.21.0_linux_x64.tar.gz"
          tar -xzf gitleaks.tar.gz
          chmod +x gitleaks
          ./gitleaks detect --no-git --source . --verbose --gitleaks-ignore-path .gitleaksignore

  trivy-scan:
    name: Container Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy (filesystem)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          severity: HIGH,CRITICAL
          exit-code: "1"
          ignore-unfixed: true

  security-audit:
    name: Security Audit (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit
        run: bandit -r services/ -f json -o bandit-report.json
        continue-on-error: true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 30

  dependency-audit:
    name: Dependency Audit (pip-audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit --requirement requirements.txt --format json --output pip-audit.json
        continue-on-error: true

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit.json
          retention-days: 30

  # ============================================
  # DOCUMENTATION CHECKS
  # ============================================

  docs-check:
    name: Documentation Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Check Markdown files
        run: |
          markdownlint '**/*.md' --ignore node_modules --ignore .venv || true

      - name: Check for broken links
        run: |
          echo "Link checking would go here (e.g., with markdown-link-check)"
          echo "Skipped in MVP phase"

  # ============================================
  # BUILD SUMMARY
  # ============================================

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [core-guard, lint, format-check, type-check, test, secrets-scan, trivy-scan, security-audit, dependency-audit, docs-check]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- Core Guard: ${{ needs.core-guard.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Format Check: ${{ needs.format-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Type Check: ${{ needs.type-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Scan: ${{ needs.trivy-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docs Check: ${{ needs.docs-check.result }}" >> $GITHUB_STEP_SUMMARY

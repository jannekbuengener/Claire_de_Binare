name: CI/CD Pipeline

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manueller Trigger

env:
  PYTHON_VERSION: '3.12'
  CACHE_VERSION: 1

jobs:
  # ============================================
  # CODE QUALITY CHECKS
  # ============================================

  core-guard:
    name: Core Duplicates Guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run core duplicates check
        run: python scripts/check_core_duplicates.py

  lint:
    name: Linting (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Ruff
        run: pip install ruff

      - name: Fetch main for diff
        run: git fetch origin main

      - name: Determine changed Python files
        id: changed
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_ref="${{ github.base_ref }}"
            base="origin/$base_ref"
          else
            base="${{ github.event.before }}"
          fi

          if [ -n "$base_ref" ]; then
            git fetch origin "$base_ref"
          fi

          git fetch origin --unshallow || true

          files=$(git diff --name-only "$base"...HEAD -- '*.py')

          relevant=$(echo "$files" | tr '\n' ' ')
          relevant=$(echo "$relevant" | tr ' ' '\n' | grep -E '^(services|tests)/' || true)
          relevant=$(echo "$relevant" | tr '\n' ' ' | sed 's/ $//')
          if [ -z "$relevant" ]; then
            echo "no_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "files=$relevant" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Ruff
        if: steps.changed.outputs.no_files != 'true'
        run: ruff check ${{ steps.changed.outputs.files }} --output-format=github

      - name: Skip lint check
        if: steps.changed.outputs.no_files == 'true'
        run: echo "Keine relevante Python-Datei geÃ¤ndert; Linting Ã¼bersprungen."

  format-check:
    name: Format Check (Black)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Black
        run: pip install black==23.12.1

      - name: Fetch main for diff
        run: git fetch origin main

      - name: Determine changed Python files
        id: changed
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_ref="${{ github.base_ref }}"
            base="origin/$base_ref"
          else
            base="${{ github.event.before }}"
          fi

          if [ -n "$base_ref" ]; then
            git fetch origin "$base_ref"
          fi

          git fetch origin --unshallow || true

          files=$(git diff --name-only "$base"...HEAD -- '*.py')

          relevant=$(echo "$files" | tr '\n' ' ')
          relevant=$(echo "$relevant" | tr ' ' '\n' | grep -E '^(services|tests)/' || true)
          relevant=$(echo "$relevant" | tr '\n' ' ' | sed 's/ $//')
          if [ -z "$relevant" ]; then
            echo "no_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "files=$relevant" >> "$GITHUB_OUTPUT"
          fi

      - name: Check formatting
        if: steps.changed.outputs.no_files != 'true'
        run: black --check --diff ${{ steps.changed.outputs.files }}

      - name: Skip formatting check
        if: steps.changed.outputs.no_files == 'true'
        run: echo "Keine Python-Datei geÃ¤ndert; FormatprÃ¼fung Ã¼bersprungen."
  type-check:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          # Install base dev requirements if they exist
          if [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
          else
            pip install mypy
          fi

      - name: Run mypy
        run: mypy services/ --ignore-missing-imports --no-strict-optional
        continue-on-error: true  # Nicht blockierend in MVP-Phase

  # ============================================
  # TESTS
  # ============================================

  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          # Install base dev requirements if they exist
          if [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
          else
            pip install pytest pytest-cov psycopg2-binary redis
          fi

      - name: Run tests with coverage
        run: |
          pytest -v -m "not e2e and not local_only" \
            --cov=core \
            --cov=services \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=0

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

      - name: Coverage comment
        if: matrix.python-version == '3.12'
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # SECURITY CHECKS
  # ============================================

  secrets-scan:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0  # Volle Historie fÃ¼r Gitleaks

      - name: Run Gitleaks
        run: |
          # Download and install gitleaks
          GITLEAKS_VERSION="v8.21.0"
          curl -sSL -o gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_8.21.0_linux_x64.tar.gz"
          tar -xzf gitleaks.tar.gz
          chmod +x gitleaks
          ./gitleaks detect --config gitleaks.toml --no-git --source . --verbose --gitleaks-ignore-path .gitleaksignore

  trivy-scan:
    name: Container Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Trivy (filesystem)
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac
        with:
          scan-type: fs
          scan-ref: .
          skip-dirs: .worktrees_backup
          severity: HIGH,CRITICAL
          exit-code: "1"
          ignore-unfixed: true

  security-audit:
    name: Security Audit (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit
        run: bandit -r services/ -f json -o bandit-report.json
        continue-on-error: true

      - name: Upload Bandit report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 30

  dependency-audit:
    name: Dependency Audit (pip-audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit --requirement requirements.txt --format json --output pip-audit.json
        continue-on-error: true

      - name: Upload pip-audit report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: pip-audit-report
          path: pip-audit.json
          retention-days: 30

  # ============================================
  # DOCUMENTATION CHECKS
  # ============================================

  docs-check:
    name: Documentation Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Check Markdown files
        run: |
          markdownlint '**/*.md' --ignore node_modules --ignore .venv || true

      - name: Check for broken links
        run: |
          echo "Link checking would go here (e.g., with markdown-link-check)"
          echo "Skipped in MVP phase"

  # ============================================
  # BUILD SUMMARY
  # ============================================

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [core-guard, lint, format-check, type-check, test, secrets-scan, trivy-scan, security-audit, dependency-audit, docs-check]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- Core Guard: ${{ needs.core-guard.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Format Check: ${{ needs.format-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Type Check: ${{ needs.type-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Scan: ${{ needs.trivy-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docs Check: ${{ needs.docs-check.result }}" >> $GITHUB_STEP_SUMMARY

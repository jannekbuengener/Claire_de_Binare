name: Branch Policy Enforcement

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main
      - develop

jobs:
  validate-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Validate branch name
        run: |
          branch_name="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch name: $branch_name"
          
          # Allow main and develop branches
          if [[ "$branch_name" == "main" || "$branch_name" == "develop" ]]; then
            echo "âœ… Main/develop branch allowed"
            exit 0
          fi
          
          # Allow dependabot branches
          if [[ "$branch_name" =~ ^dependabot/ ]]; then
            echo "âœ… Valid dependabot branch name: $branch_name"
            exit 0
          fi
          
          # Validate feature branch naming convention
          if [[ "$branch_name" =~ ^feature/[a-z0-9-]+$ ]]; then
            echo "âœ… Valid feature branch name: $branch_name"
          elif [[ "$branch_name" =~ ^hotfix/[a-z0-9-]+$ ]]; then
            echo "âœ… Valid hotfix branch name: $branch_name"
          elif [[ "$branch_name" =~ ^bugfix/[a-z0-9-]+$ ]]; then
            echo "âœ… Valid bugfix branch name: $branch_name"
          elif [[ "$branch_name" =~ ^release/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âœ… Valid release branch name: $branch_name"
          else
            echo "âŒ Invalid branch name: $branch_name"
            echo "Branch names must follow these patterns:"
            echo "  - feature/short-description (lowercase, hyphens only)"
            echo "  - hotfix/short-description (lowercase, hyphens only)"
            echo "  - bugfix/short-description (lowercase, hyphens only)"
            echo "  - release/vX.Y.Z (semantic version)"
            echo "  - dependabot/* (automatic dependency updates)"
            exit 1
          fi

  validate-feature-workflow:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'feature/')
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        
      - name: Check feature workflow compliance
        run: |
          echo "ðŸ” Validating feature workflow compliance..."
          
          # Check if PR follows feature workflow template
          if ! grep -q "## Agent Approvals" .github/pull_request_template.md; then
            echo "âŒ PR template missing agent approvals section"
            exit 1
          fi
          
          # Check for feature flag configuration (if feature flags directory exists)
          if [ -d "config" ]; then
            echo "âœ… Configuration directory present"
          fi
          
          # Check for test files
          if [ -d "tests" ]; then
            echo "âœ… Tests directory present"
          else
            echo "âš ï¸  No tests directory found"
          fi
          
          echo "âœ… Basic feature workflow validation passed"

  enforce-pr-template:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR template usage
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const body = pr.body || '';

            // Full feature template sections
            const featureTemplateSections = [
              '## Feature Overview',
              '## Technical Overview',
              '## Test Evidence',
              '## Code Quality',
              '## Deployment & Rollback',
              '## Documentation',
              '## Agent Approvals'
            ];

            // Minimal template for chore/fix/docs PRs
            const hasMinimalTemplate = body.includes('## Summary') &&
                                       (body.match(/^##\s+/gm) || []).length >= 2;

            // Check for full template
            const missingSections = featureTemplateSections.filter(section =>
              !body.includes(section)
            );

            const hasFullTemplate = missingSections.length === 0;

            if (!hasFullTemplate && !hasMinimalTemplate) {
              core.setFailed(`PR must use either: (1) Full feature template with sections: ${featureTemplateSections.join(', ')}, OR (2) Minimal template with "## Summary" + at least one other section`);
            } else {
              if (hasFullTemplate) {
                console.log('âœ… Full PR template present');
              } else {
                console.log('âœ… Minimal PR template present (Summary + sections)');
              }
            }
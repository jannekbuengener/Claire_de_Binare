# Gitleaks Secret Scanning
# Issue #313: Configure gitleaks secret-scanning in CI
#
# Scans for secrets in:
# - All commits in PRs
# - Push to main/develop
# - Weekly full repo scan

name: Gitleaks Secret Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 3 * * 0'  # Weekly Sunday 03:00 UTC
  workflow_dispatch:

jobs:
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0  # Full history for PR scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: gitleaks.toml
          GITLEAKS_ENABLE_COMMENTS: true  # Comment on PRs with findings

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc
        with:
          sarif_file: results.sarif
        continue-on-error: true  # Don't fail if no SARIF generated

  # Full repo scan (scheduled only)
  full-scan:
    name: Full Repository Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.21.2/gitleaks_8.21.2_linux_x64.tar.gz
          tar -xzf gitleaks_8.21.2_linux_x64.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/

      - name: Full Scan
        run: |
          gitleaks detect \
            --config=gitleaks.toml \
            --source=. \
            --report-format=sarif \
            --report-path=gitleaks-full.sarif \
            --verbose

      - name: Upload Full Scan SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc
        with:
          sarif_file: gitleaks-full.sarif
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "## Gitleaks Full Repository Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Scan Type: Full repository history" >> $GITHUB_STEP_SUMMARY
          echo "- Config: gitleaks.toml" >> $GITHUB_STEP_SUMMARY
          echo "- Ignorelist: .gitleaksignore" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f gitleaks-full.sarif ]; then
            echo "SARIF report uploaded to GitHub Security tab." >> $GITHUB_STEP_SUMMARY
          fi

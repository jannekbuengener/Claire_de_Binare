name: Security Scan

# Weekly scan + PR trigger for infrastructure changes
# Issue #97: Trivy Container Scanning
on:
  schedule:
    - cron: '0 2 * * 1'  # Monday 02:00 UTC
  push:
    branches:
      - main
      - 'release/*'
    paths:
      - 'services/**/Dockerfile'
      - 'infrastructure/compose/**'
      - '.github/workflows/security-scan.yml'
  workflow_dispatch:  # Manual trigger

env:
  TRIVY_VERSION: "0.58.0"
  TRIVY_SUMMARY_MAX: "5"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # TRIVY SCANNING (Issue #97)
  # ============================================================================
  trivy-scan-base:
    name: Trivy - Base Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - redis:7.4.1-alpine
          - postgres:15.11-alpine
          - prom/prometheus:v3.1.0
          - grafana/grafana:11.4.0
      fail-fast: false

    steps:
      - name: Pull Image
        run: docker pull ${{ matrix.image }}

      - name: Set Trivy safe image name
        run: |
          safe_image=$(echo "${{ matrix.image }}" | tr '/:' '-')
          echo "TRIVY_SAFE_IMAGE=$safe_image" >> $GITHUB_ENV

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          image-ref: '${{ matrix.image }}'
          format: 'json'
          exit-code: '0'  # Don't fail on base images - document risks
          severity: 'CRITICAL,HIGH'
          output: 'trivy-${{ env.TRIVY_SAFE_IMAGE }}.json'

      - name: Summarize Trivy Results
        if: always()
        run: |
          set -euo pipefail
          report="trivy-${{ env.TRIVY_SAFE_IMAGE }}.json"
          echo "### Trivy (base) ${{ matrix.image }}" >> "$GITHUB_STEP_SUMMARY"
          if [ ! -s "$report" ]; then
            echo "- No report generated." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          total=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL")] | length' "$report")
          echo "- HIGH/CRITICAL: $total" >> "$GITHUB_STEP_SUMMARY"
          echo "Top findings:" >> "$GITHUB_STEP_SUMMARY"
          jq -r '.Results[].Vulnerabilities[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL") | "\(.Severity) \(.VulnerabilityID) \(.PkgName // "unknown") \(.InstalledVersion // "")"' "$report" | head -n "${TRIVY_SUMMARY_MAX}" >> "$GITHUB_STEP_SUMMARY"

      - name: Run Trivy SARIF
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          image-ref: '${{ matrix.image }}'
          format: 'sarif'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-${{ env.TRIVY_SAFE_IMAGE }}.sarif'

      - name: Upload Trivy Results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: trivy-base-${{ env.TRIVY_SAFE_IMAGE }}-${{ github.run_number }}
          path: trivy-*.json

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
        if: always()
        with:
          sarif_file: 'trivy-${{ env.TRIVY_SAFE_IMAGE }}.sarif'

  trivy-scan-custom:
    name: Trivy - Custom Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - allocation
          - db_writer
          - execution
          - market
          - regime
          - risk
          - signal
          - ws
      fail-fast: false

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Service Image
        id: build_custom_image
        continue-on-error: true
        run: |
          docker build -f services/${{ matrix.service }}/Dockerfile \
            -t cdb_${{ matrix.service }}:scan .

      - name: Note skipped service build
        if: steps.build_custom_image.outcome != 'success'
        run: |
          if [ "${{ matrix.service }}" = "market" ]; then
            echo "- skipped market: build failed (missing service.py/email_alerter.py)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- skipped ${{ matrix.service }}: build failed" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Run Trivy Scan
        if: steps.build_custom_image.outcome == 'success'
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          image-ref: 'cdb_${{ matrix.service }}:scan'
          format: 'json'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-cdb_${{ matrix.service }}.json'

      - name: Summarize Trivy Results
        id: trivy_gate
        if: steps.build_custom_image.outcome == 'success'
        run: |
          set -euo pipefail
          report="trivy-cdb_${{ matrix.service }}.json"
          echo "### Trivy (custom) ${{ matrix.service }}" >> "$GITHUB_STEP_SUMMARY"
          if [ ! -s "$report" ]; then
            echo "- No report generated." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
          jq -r '.Results[].Vulnerabilities[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL") | .VulnerabilityID' "$report" | sort -u > /tmp/trivy-high.txt
          total=$(wc -l < /tmp/trivy-high.txt | tr -d ' ')
          echo "- HIGH/CRITICAL: $total" >> "$GITHUB_STEP_SUMMARY"
          if [ "$total" -eq 0 ]; then
            exit 0
          fi
          allowlist="${TRIVY_ALLOWLIST_CVES:-}"
          if [ -n "$allowlist" ]; then
            printf "%s\n" "${allowlist//,/\\n}" | sed '/^$/d' > /tmp/trivy-allow.txt
            grep -v -F -x -f /tmp/trivy-allow.txt /tmp/trivy-high.txt > /tmp/trivy-disallowed.txt || true
          else
            cp /tmp/trivy-high.txt /tmp/trivy-disallowed.txt
          fi
          disallowed=$(wc -l < /tmp/trivy-disallowed.txt | tr -d ' ')
          echo "- Allowlist: ${allowlist:-none}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Disallowed: $disallowed" >> "$GITHUB_STEP_SUMMARY"
          echo "Top findings:" >> "$GITHUB_STEP_SUMMARY"
          jq -r '.Results[].Vulnerabilities[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL") | "\(.Severity) \(.VulnerabilityID) \(.PkgName // "unknown") \(.InstalledVersion // "")"' "$report" | head -n "${TRIVY_SUMMARY_MAX}" >> "$GITHUB_STEP_SUMMARY"
          if [ "$disallowed" -ne 0 ]; then
            echo "Disallowed CVEs:" >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/trivy-disallowed.txt >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

      - name: Run Trivy SARIF
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        if: always() && steps.build_custom_image.outcome == 'success'
        with:
          image-ref: 'cdb_${{ matrix.service }}:scan'
          format: 'sarif'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-cdb_${{ matrix.service }}.sarif'

      - name: Upload Trivy Results
        if: always() && steps.build_custom_image.outcome == 'success'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: trivy-custom-${{ matrix.service }}-${{ github.run_number }}
          path: trivy-*.json

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
        if: always() && steps.build_custom_image.outcome == 'success'
        with:
          sarif_file: 'trivy-cdb_${{ matrix.service }}.sarif'

  # ============================================================================
  # DOCKER SCOUT SCANNING (Original)
  # ============================================================================
  scan-base-images:
    name: Scan Base Images (Redis, Postgres)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        image:
          - redis:7.4.1-alpine
          - postgres:15.11-alpine
      fail-fast: false

    env:
      SCAN_IMAGE: ${{ matrix.image }}

    steps:
      - name: Pull Image
        run: docker pull ${{ matrix.image }}

      - name: Set scan artifact names
        run: |
          label="${SCAN_IMAGE//:/-}"
          echo "SCAN_IMAGE_LABEL=$label" >> $GITHUB_ENV
          echo "SCAN_ARTIFACT_NAME=scan-${label}-${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Save Scan Results
        if: always()
        run: |
          docker scout cves ${{ env.SCAN_IMAGE }} --severity critical,high > scan-${{ env.SCAN_IMAGE_LABEL }}.txt || true

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ env.SCAN_ARTIFACT_NAME }}
          path: scan-${{ env.SCAN_IMAGE_LABEL }}.txt
          retention-days: 30

  scan-custom-images:
    name: Scan Custom Python Services
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - allocation
          - db_writer
          - execution
          - market
          - regime
          - risk
          - signal
          - ws
      fail-fast: false

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Service Image
        id: build_custom_image
        continue-on-error: true
        run: |
          docker build -f services/${{ matrix.service }}/Dockerfile \
            -t claire_de_binare-cdb_${{ matrix.service }}:scan .

      - name: Note skipped service build
        if: steps.build_custom_image.outcome != 'success'
        run: |
          if [ "${{ matrix.service }}" = "market" ]; then
            echo "- skipped market: build failed (missing service.py/email_alerter.py)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- skipped ${{ matrix.service }}: build failed" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Save Scan Results
        if: always() && steps.build_custom_image.outcome == 'success'
        run: |
          docker scout cves claire_de_binare-cdb_${{ matrix.service }}:scan \
            --severity critical,high > scan-cdb_${{ matrix.service }}.txt || true

      - name: Upload Scan Results
        if: always() && steps.build_custom_image.outcome == 'success'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: scan-cdb_${{ matrix.service }}-${{ github.run_number }}
          path: scan-cdb_${{ matrix.service }}.txt
          retention-days: 30

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [trivy-scan-base, trivy-scan-custom, scan-base-images, scan-custom-images]
    if: always()

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trivy Scans (Issue #97)" >> $GITHUB_STEP_SUMMARY
          echo "- Base Images: redis, postgres, prometheus, grafana" >> $GITHUB_STEP_SUMMARY
          echo "- Custom Images: 8 Python services" >> $GITHUB_STEP_SUMMARY
          echo "- SARIF reports uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Scout Scans" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Known Issues (Documented as Accepted Risk)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**gosu Binary CVEs in Redis/Postgres base images:**" >> $GITHUB_STEP_SUMMARY
          echo "- 4 CRITICAL + 40 HIGH CVEs from Go stdlib 1.18.2" >> $GITHUB_STEP_SUMMARY
          echo "- Risk: LOW (startup-only, no network exposure)" >> $GITHUB_STEP_SUMMARY
          echo "- Documented in: \`docs/security/SECURITY_BASELINE.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- Upstream tracking: docker-library/redis, docker-library/postgres" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Custom Images" >> $GITHUB_STEP_SUMMARY
          echo "- All Python services use pip 25.3 (CVE-2025-8869 resolved)" >> $GITHUB_STEP_SUMMARY
          echo "- CRITICAL/HIGH in custom images fails unless allowlisted: ${TRIVY_ALLOWLIST_CVES}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan artifacts available for 30 days." >> $GITHUB_STEP_SUMMARY

# IMPORTANT NOTES:
# 1. Base image scans (Redis/Postgres) set exit-code: false
#    - gosu CVEs are documented as accepted risk in docs/security/SECURITY_BASELINE.md
#    - Attack surface: minimal (startup-only, no network exposure)
#    - Weekly scans monitor for NEW vulnerabilities
#
# 2. Custom image scans set exit-code: true
#    - pip 25.3 resolves CVE-2025-8869
#    - NEW CRITICAL/HIGH CVEs will fail the workflow
#
# 3. Upgrade workflow when upstream fixes gosu:
#    - Monitor: https://github.com/docker-library/redis/issues
#    - Monitor: https://github.com/docker-library/postgres/issues
#    - Re-scan after base image updates
#
# 4. For manual scans:
#    docker scout cves redis:7.4.1-alpine --only-severities critical,high
#    docker scout cves postgres:15.11-alpine --only-severities critical,high

name: Security Scan

# Weekly scan + PR trigger for infrastructure changes
# Issue #97: Trivy Container Scanning
on:
  schedule:
    - cron: '0 2 * * 1'  # Monday 02:00 UTC
  pull_request:
    paths:
      - 'services/**/Dockerfile'
      - 'infrastructure/compose/**'
      - '.github/workflows/security-scan.yml'
  workflow_dispatch:  # Manual trigger

env:
  TRIVY_VERSION: "0.58.0"

jobs:
  # ============================================================================
  # TRIVY SCANNING (Issue #97)
  # ============================================================================
  trivy-scan-base:
    name: Trivy - Base Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - redis:7.4.1-alpine
          - postgres:15.11-alpine
          - prom/prometheus:v3.1.0
          - grafana/grafana:11.4.0
      fail-fast: false

    steps:
      - name: Pull Image
        run: docker pull ${{ matrix.image }}

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          image-ref: '${{ matrix.image }}'
          format: 'table'
          exit-code: '0'  # Don't fail on base images - document risks
          severity: 'CRITICAL,HIGH'
          output: 'trivy-${{ matrix.image }}.txt'

      - name: Run Trivy SARIF
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          image-ref: '${{ matrix.image }}'
          format: 'sarif'
          output: 'trivy-${{ matrix.image }}.sarif'

      - name: Upload Trivy Results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: trivy-base-${{ matrix.image }}-${{ github.run_number }}
          path: trivy-*.txt

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.image }}.sarif'

  trivy-scan-custom:
    name: Trivy - Custom Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - allocation
          - db_writer
          - execution
          - market
          - regime
          - risk
          - signal
          - ws
      fail-fast: false

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Service Image
        run: |
          docker build -f services/${{ matrix.service }}/Dockerfile \
            -t cdb_${{ matrix.service }}:scan .

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          image-ref: 'cdb_${{ matrix.service }}:scan'
          format: 'table'
          exit-code: '1'  # FAIL on CRITICAL/HIGH in custom images
          severity: 'CRITICAL,HIGH'
          output: 'trivy-cdb_${{ matrix.service }}.txt'

      - name: Run Trivy SARIF
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        if: always()
        with:
          image-ref: 'cdb_${{ matrix.service }}:scan'
          format: 'sarif'
          output: 'trivy-cdb_${{ matrix.service }}.sarif'

      - name: Upload Trivy Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: trivy-custom-${{ matrix.service }}-${{ github.run_number }}
          path: trivy-*.txt

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
        if: always()
        with:
          sarif_file: 'trivy-cdb_${{ matrix.service }}.sarif'

  # ============================================================================
  # DOCKER SCOUT SCANNING (Original)
  # ============================================================================
  scan-base-images:
    name: Scan Base Images (Redis, Postgres)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        image:
          - redis:7.4.1-alpine
          - postgres:15.11-alpine
      fail-fast: false

    env:
      SCAN_IMAGE: ${{ matrix.image }}
      SCAN_IMAGE_LABEL: ${{ replace(matrix.image, ':', '-') }}
      SCAN_ARTIFACT_NAME: ${{ format('scan-{0}-{1}', replace(matrix.image, ':', '-'), github.run_number) }}

    steps:
      - name: Pull Image
        run: docker pull ${{ matrix.image }}

      - name: Save Scan Results
        if: always()
        run: |
          docker scout cves ${{ env.SCAN_IMAGE }} --severity critical,high > scan-${{ env.SCAN_IMAGE_LABEL }}.txt || true

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ env.SCAN_ARTIFACT_NAME }}
          path: scan-${{ env.SCAN_IMAGE_LABEL }}.txt
          retention-days: 30

  scan-custom-images:
    name: Scan Custom Python Services
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - allocation
          - db_writer
          - execution
          - market
          - regime
          - risk
          - signal
          - ws
      fail-fast: false

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build Service Image
        run: |
          docker build -f services/${{ matrix.service }}/Dockerfile \
            -t claire_de_binare-cdb_${{ matrix.service }}:scan .

      - name: Save Scan Results
        if: always()
        run: |
          docker scout cves claire_de_binare-cdb_${{ matrix.service }}:scan \
            --severity critical,high > scan-cdb_${{ matrix.service }}.txt || true

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: scan-cdb_${{ matrix.service }}-${{ github.run_number }}
          path: scan-cdb_${{ matrix.service }}.txt
          retention-days: 30

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [trivy-scan-base, trivy-scan-custom, scan-base-images, scan-custom-images]
    if: always()

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trivy Scans (Issue #97)" >> $GITHUB_STEP_SUMMARY
          echo "- Base Images: redis, postgres, prometheus, grafana" >> $GITHUB_STEP_SUMMARY
          echo "- Custom Images: 8 Python services" >> $GITHUB_STEP_SUMMARY
          echo "- SARIF reports uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Scout Scans" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Known Issues (Documented as Accepted Risk)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**gosu Binary CVEs in Redis/Postgres base images:**" >> $GITHUB_STEP_SUMMARY
          echo "- 4 CRITICAL + 40 HIGH CVEs from Go stdlib 1.18.2" >> $GITHUB_STEP_SUMMARY
          echo "- Risk: LOW (startup-only, no network exposure)" >> $GITHUB_STEP_SUMMARY
          echo "- Documented in: \`docs/security/SECURITY_BASELINE.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- Upstream tracking: docker-library/redis, docker-library/postgres" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Custom Images" >> $GITHUB_STEP_SUMMARY
          echo "- All Python services use pip 25.3 (CVE-2025-8869 resolved)" >> $GITHUB_STEP_SUMMARY
          echo "- NEW CRITICAL/HIGH CVEs in custom images will fail this workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan artifacts available for 30 days." >> $GITHUB_STEP_SUMMARY

# IMPORTANT NOTES:
# 1. Base image scans (Redis/Postgres) set exit-code: false
#    - gosu CVEs are documented as accepted risk in docs/security/SECURITY_BASELINE.md
#    - Attack surface: minimal (startup-only, no network exposure)
#    - Weekly scans monitor for NEW vulnerabilities
#
# 2. Custom image scans set exit-code: true
#    - pip 25.3 resolves CVE-2025-8869
#    - NEW CRITICAL/HIGH CVEs will fail the workflow
#
# 3. Upgrade workflow when upstream fixes gosu:
#    - Monitor: https://github.com/docker-library/redis/issues
#    - Monitor: https://github.com/docker-library/postgres/issues
#    - Re-scan after base image updates
#
# 4. For manual scans:
#    docker scout cves redis:7.4.1-alpine --only-severities critical,high
#    docker scout cves postgres:15.11-alpine --only-severities critical,high

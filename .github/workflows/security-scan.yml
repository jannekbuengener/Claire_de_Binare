name: Security Scan

# Weekly scan + PR trigger for infrastructure changes
on:
  schedule:
    - cron: '0 2 * * 1'  # Monday 02:00 UTC
  pull_request:
    paths:
      - 'services/**/Dockerfile'
      - 'infrastructure/compose/**'
      - '.github/workflows/security-scan.yml'
  workflow_dispatch:  # Manual trigger

jobs:
  scan-base-images:
    name: Scan Base Images (Redis, Postgres)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        image:
          - redis:7.4.1-alpine
          - postgres:15.11-alpine
      fail-fast: false

    steps:
      - name: Pull Image
        run: docker pull ${{ matrix.image }}

      - name: Docker Scout Scan
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ matrix.image }}
          only-severities: critical,high
          exit-code: false  # Don't fail - we document gosu CVEs as accepted risk

      - name: Save Scan Results
        if: always()
        run: |
          docker scout cves ${{ matrix.image }} --only-severities critical,high > scan-${{ matrix.image }}.txt || true

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-${{ matrix.image }}-${{ github.run_number }}
          path: scan-${{ matrix.image }}.txt
          retention-days: 30

  scan-custom-images:
    name: Scan Custom Python Services
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - allocation
          - db_writer
          - execution
          - market
          - regime
          - risk
          - signal
          - ws
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Build Service Image
        run: |
          docker build -f services/${{ matrix.service }}/Dockerfile \
            -t claire_de_binare-cdb_${{ matrix.service }}:scan .

      - name: Docker Scout Scan
        uses: docker/scout-action@v1
        with:
          command: cves
          image: claire_de_binare-cdb_${{ matrix.service }}:scan
          only-severities: critical,high
          exit-code: true  # Fail on CRITICAL/HIGH in custom images

      - name: Save Scan Results
        if: always()
        run: |
          docker scout cves claire_de_binare-cdb_${{ matrix.service }}:scan \
            --only-severities critical,high > scan-cdb_${{ matrix.service }}.txt || true

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-cdb_${{ matrix.service }}-${{ github.run_number }}
          path: scan-cdb_${{ matrix.service }}.txt
          retention-days: 30

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [scan-base-images, scan-custom-images]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Known Issues (Documented as Accepted Risk)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**gosu Binary CVEs in Redis/Postgres base images:**" >> $GITHUB_STEP_SUMMARY
          echo "- 4 CRITICAL + 40 HIGH CVEs from Go stdlib 1.18.2" >> $GITHUB_STEP_SUMMARY
          echo "- Risk: LOW (startup-only, no network exposure)" >> $GITHUB_STEP_SUMMARY
          echo "- Documented in: \`docs/security/SECURITY_BASELINE.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- Upstream tracking: docker-library/redis, docker-library/postgres" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Custom Images" >> $GITHUB_STEP_SUMMARY
          echo "- All Python services use pip 25.3 (CVE-2025-8869 resolved)" >> $GITHUB_STEP_SUMMARY
          echo "- NEW CRITICAL/HIGH CVEs in custom images will fail this workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan artifacts available for 30 days." >> $GITHUB_STEP_SUMMARY

# IMPORTANT NOTES:
# 1. Base image scans (Redis/Postgres) set exit-code: false
#    - gosu CVEs are documented as accepted risk in docs/security/SECURITY_BASELINE.md
#    - Attack surface: minimal (startup-only, no network exposure)
#    - Weekly scans monitor for NEW vulnerabilities
#
# 2. Custom image scans set exit-code: true
#    - pip 25.3 resolves CVE-2025-8869
#    - NEW CRITICAL/HIGH CVEs will fail the workflow
#
# 3. Upgrade workflow when upstream fixes gosu:
#    - Monitor: https://github.com/docker-library/redis/issues
#    - Monitor: https://github.com/docker-library/postgres/issues
#    - Re-scan after base image updates
#
# 4. For manual scans:
#    docker scout cves redis:7.4.1-alpine --only-severities critical,high
#    docker scout cves postgres:15.11-alpine --only-severities critical,high
